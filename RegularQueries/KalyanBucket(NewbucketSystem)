
select * into #Deluxe FROM 
(

SELECT distinct(customercode)
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '100000' and '200000' and divisioncode = 'Gold' and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')

  union

  SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where   Netamount <= 25000  and divisioncode = 'Diamond' 
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')
  
  union

  
SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount <= 50000  and divisioncode = 'Diamond' 
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')
  and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')

  union

  select distinct customercode [NoofCustomers] from (
SELECT customercode,count(distinct [BillDate]) [FrequencyofVisit]
FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
where customercode is not null
group by customercode) as a where  [FrequencyofVisit] in (3,4) ) as a
------------------------------------------------------------------------------------------------------------------
---Add customers to table Premium_customers 

select * into #Premium FROM 
(

SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '200001' and '500000' and divisioncode = 'Gold' and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')

  union

SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '25001' and '75001'  and divisioncode = 'Diamond' 
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')and sectionname not in ('COIN','LOCKET - COIN')

  and TransactionType not in ('Sales_Return')
  
  union

SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '50001' and '150000'  and divisioncode = 'Diamond' 
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS') and sectionname not in ('COIN','LOCKET - COIN')

  and TransactionType not in ('Sales_Return')

  union

select distinct customercode [NoofCustomers] from (
SELECT customercode,count(distinct [BillDate]) [FrequencyofVisit]
FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
where customercode is not null
group by customercode) as a where  [FrequencyofVisit] > 4 ) as a
------------------------------------------------------------------------------------------------------------------

-----Add customers to table Kalyanclub_customers 


select * into #KalyanClub FROM 
(

SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netweight > 80  and divisioncode = 'Gold' and sectionname not in ('COIN','LOCKET - COIN')
  --and makename in ('MUDHRA','NIMAH','SANKALP')

  and TransactionType not in ('Sales_Return')
  union

SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount > '75001'   and divisioncode = 'Diamond' 
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')and sectionname not in ('COIN','LOCKET - COIN')

  and TransactionType not in ('Sales_Return')

  union
    select distinct a.customercode from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo] as a,
  (
  select customercode,YEAR(billdate) as year,SUM(netamount) as netamount
  from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where divisioncode = 'Diamond' and sectionname not in ('COIN','LOCKET - COIN')
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')
  and TransactionType not in ('Sales_Return')
  group by customercode,YEAR(billdate)
  having SUM(netamount) > 150000.00
  ) as b
  where a.CustomerCode in (b.CustomerCode)
  union

SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount > '150001'  and divisioncode = 'Diamond' 
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS') and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')

union
    select distinct a.customercode from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo] as a,
  (
  select customercode,YEAR(billdate) as year,SUM(netamount) as netamount
  from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where divisioncode = 'Diamond' and sectionname not in ('COIN','LOCKET - COIN')
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')
  and TransactionType not in ('Sales_Return')
  group by customercode,YEAR(billdate)
  having SUM(netamount) > 300000.00
  ) as b
  where a.CustomerCode in (b.CustomerCode)

  ) as c
------------------------------------------------------------------------------------------------------------------

select * into Basic_Customers FROM 

(

select distinct(customercode)
FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
where customercode is not null and sectionname in ('COIN','LOCKET - COIN') or divisioncode = 'Silver'
and TransactionType not in ('Sales_Return')
  
union

select distinct customercode [NoofCustomers] from (
SELECT customercode,count(distinct [BillDate]) [FrequencyofVisit]
FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
where customercode is not null
group by customercode) as a where  [FrequencyofVisit] <=2 
) as a
------------------------------------------------------------------------------------------------------------------

select * into HighestBucket_Customers FROM 

( SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount > 500000 and divisioncode = 'Gold' and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')

union 

SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount >= 150000 and divisioncode = 'Diamond' and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')
 
 union
 
 SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount > 300000 and divisioncode = 'Diamond' 
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS') and sectionname not in ('COIN','LOCKET - COIN')

  and TransactionType not in ('Sales_Return') ) as a
------------------------------------------------------------------------------------------------------------------

Queries for Store scorcard

  
  droptable #scoreRFM1
  
  select [JoinLocationState],[JoinLocation],avg([RecencyQuintiles])as R
  ,avg([FrequencyQuintiles]) as F
  ,avg([MonetaryQuintiles])as M
  ,avg([RFM_Final_SCORE])as RFM
  ,count([CustomerCode])as customer
 into #scoreRFM
 from [Kalyan_Sales].[dbo].[temp_20160629_CustomerCodeJoinedFromApr14]
 where Joindate between '2014-04-01' and '2015-12-31' 

 group by [JoinLocation],[JoinLocationState]
 order by [JoinLocation]

 select * from #scoreRFM

 
 drop table #scoremela

  select [JoinLocationState],[JoinLocation],sum([MobileScore])as mobile
  ,sum([EmailScore]) as email
  ,sum([ResidencePhoneScore])as phone
  ,sum([AddressScore])as address
  ,avg([MelaScore]) as melascore
  ,count([CustomerCode])as customer
 into #scoremela
 from [Kalyan_Sales].[dbo].[temp_20160629_CustomerCodeJoinedFromApr14]
  where Joindate between '2014-04-01' and '2016-06-30' 

 group by [JoinLocation],[JoinLocationState]
 order by [JoinLocation]

  select * from #scoremela
  
  
  
  
  select distinct a.customercode from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo] as a,
  (
  select customercode,YEAR(billdate) as year,SUM(netamount) as netamount
  from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where divisioncode = 'Diamond' and sectionname not in ('COIN','LOCKET - COIN')
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')
  and TransactionType not in ('Sales_Return')
  group by customercode,YEAR(billdate)
  having SUM(netamount) > 300000.00
  ) as b
  where a.CustomerCode in (b.CustomerCode)



select distinct customercode 
into #cust
from  [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]



alter table #cust
add bucket varchar(20)

update #cust
set bucket = 'Kalyan Club'
where customercode in (select distinct customercode from #kalyanclub)

update #cust
set bucket = 'Premium'
where customercode in (select distinct customercode from #Premium)
and bucket is null


update #cust
set bucket = 'Deluxe'
where customercode in (select distinct customercode from #Deluxe)
and bucket is null

update #cust 
set bucket = 'Basic'
where bucket is null

select COUNT(customercode) from #cust
select COUNT(bucket) from #cust

select COUNT(*) from #cust
where bucket is null

select bucket, COUNT(customercode) from #cust
group by bucket

select * 
into [Kalyan_Temp].[dbo].[temp_sp_Buckets_20170113]
from #cust

select top 100 * from #cust

alter table #cust
add gold varchar(5)

update #cust
set gold = 'KC'
where customercode in (SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netweight > 80  and divisioncode = 'Gold' and sectionname not in ('COIN','LOCKET - COIN')
  --and makename in ('MUDHRA','NIMAH','SANKALP')

  and TransactionType not in ('Sales_Return'))
  
update #cust
set gold = 'PR'
where customercode in (SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '200001' and '500000' and divisioncode = 'Gold' and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return'))
  and gold is null
  
  update #cust
set gold = 'DE'
where customercode in (SELECT distinct(customercode)
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '100000' and '200000' and divisioncode = 'Gold' and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return'))
  and gold is null
  
  
  alter table #cust
  add diamond varchar(5)
  
  select top 100 * from #cust
  
  update #cust
  set diamond='KC'
  where customercode in (SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount > '75001'   and divisioncode = 'Diamond' 
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')and sectionname not in ('COIN','LOCKET - COIN')

  and TransactionType not in ('Sales_Return')

  union
    select distinct a.customercode from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo] as a,
  (
  select customercode,YEAR(billdate) as year,SUM(netamount) as netamount
  from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where divisioncode = 'Diamond' and sectionname not in ('COIN','LOCKET - COIN')
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')
  and TransactionType not in ('Sales_Return')
  group by customercode,YEAR(billdate)
  having SUM(netamount) > 150000.00
  ) as b
  where a.CustomerCode in (b.CustomerCode))
  
    update #cust
  set diamond='PR'
  where customercode in (SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '25001' and '75001'  and divisioncode = 'Diamond' 
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')and sectionname not in ('COIN','LOCKET - COIN')

  and TransactionType not in ('Sales_Return'))
  and diamond is null
  
  
      update #cust
  set diamond='DE'
  where customercode in (  SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where   Netamount <= 25000  and divisioncode = 'Diamond' 
  and GroupName not in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return'))
  and diamond is null
  
  select top 100 * from #cust
  
  alter table #cust
  add uncut varchar(5)
  
  update #cust
  set uncut = 'KC'
  where customercode in (SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount > '150001'  and divisioncode = 'Diamond' 
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS') and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return')

union
    select distinct a.customercode from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo] as a,
  (
  select customercode,YEAR(billdate) as year,SUM(netamount) as netamount
  from [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where divisioncode = 'Diamond' and sectionname not in ('COIN','LOCKET - COIN')
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')
  and TransactionType not in ('Sales_Return')
  group by customercode,YEAR(billdate)
  having SUM(netamount) > 300000.00
  ) as b
  where a.CustomerCode in (b.CustomerCode))
  
    update #cust
  set uncut = 'PR'
  where customercode in (SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount between '50001' and '150000'  and divisioncode = 'Diamond' 
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS') and sectionname not in ('COIN','LOCKET - COIN')

  and TransactionType not in ('Sales_Return'))
  and uncut is null
  
  
  update #cust
  set uncut = 'DE'
  where customercode in (SELECT distinct customercode
  FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
  where  Netamount <= 50000  and divisioncode = 'Diamond' 
  and GroupName in ('UNCUT DIAMOND ORNAMENTS','UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS','OLD UNCUT DIAMOND WITH COLOUR STONE ORNAMENTS')
  and sectionname not in ('COIN','LOCKET - COIN')
  and TransactionType not in ('Sales_Return'))
  and uncut is null

alter table #cust
add visit varchar(5)

update #cust
set visit = 'PR'
where customercode in (select distinct customercode [NoofCustomers] from (
SELECT customercode,count(distinct [BillDate]) [FrequencyofVisit]
FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
where customercode is not null
group by customercode) as a where  [FrequencyofVisit] > 4 )

update #cust
set visit = 'DE'
where customercode in (  select distinct customercode [NoofCustomers] from (
SELECT customercode,count(distinct [BillDate]) [FrequencyofVisit]
FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
where customercode is not null
group by customercode) as a where  [FrequencyofVisit] in (3,4))
and visit is null 

update #cust
set visit = 'BA'
where customercode in (select distinct customercode [NoofCustomers] from (
SELECT customercode,count(distinct [BillDate]) [FrequencyofVisit]
FROM [Kalyan_Master].[dbo].[tbl_Master_Capillary_JuelTransInfo]
where customercode is not null
group by customercode) as a where  [FrequencyofVisit] <=2)
and visit is null
 
select top 100 * from #cust

select * 
into [Kalyan_Temp].[dbo].[temp_sp_Buckets_20170113_2]
from #cust


select top 100 * from #cust
